<!DOCTYPE html>
<html lang="pt">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Alfa+Slab+One&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@500&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="32x32" href="css/img/logo Bolttech.svg">
  <title>Bolttech</title>
  <link rel="stylesheet" href="css/dashboards.css">
  <link rel="stylesheet" href="css/estufas.css">

  <!-- script do google charts -->
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript" src="funcoes.js"></script>



<body onload="atualizacaoPeriodica()" onload="estufas(10)">
  <!--header inicio-->

  <div class="header">
    <div class="container">
      <div class="intrologo">
        <img class="fv32" src="css/img/logo Bolttech.svg" alt="icon">
        <h1>Bolttech</h1>
      </div>
      <div class="usuario">
        <h3>Usuário, <br> <b id="c_usuario"></b></h3>
      </div>
      <div class="nav">
        <ul>
          <li><a href="graficousuario.html">Histórico recente</a></li>
          <li><a href="./publicacoes.html">Publicar</a></li>
          <li><a href="#" class="highlight" onclick="logoff()">Sair</a></li>
        </ul>
      </div>
    </div>
  </div>
  <!--header fim-->

  <div class="dashboard">
    <div class="linkcontst">
      <a class="linkst" id="frio" href="" onclick="btnestufa('frio',event)">Frias</a>

      <a class="linkst" id="quente" href="" onclick="btnestufa('quente',event)">Quente</a>

      <a class="linkst" id="todos" href="" onclick="btnestufa('todas',event)">Todas</a>
    </div>

    <select id="selecao" onchange="estufas()">
      <option value="" disabled selected>Selecione uma opção</option>
      <option value="todas">Estufas em alertas </option>
      <option value=1>Estufa 1</option>
      <option value=2>Estufa 2</option>
      <option value=3>Estufa 3</option>
      <option value=4>Estufa 4</option>
      <option value=5>Estufa 5</option>
    </select>
    <h1 class="ttesfutas"> Estufas: <span id="b_usuario"></span> </h1>
    <h1 id="id_estadoestufa"></h1>
    <div class="estufa_cont">



      <div class="estufas">
        <h4>Estufa <span name="namecaminhao" id="idSensor" value="1">1</span></h4>
        <div class="valores">
          <div class="valor" id="div_temperatura">Temperatura sendo obtida...</div>

        </div>
        <div class="alertas">
          <div class="alerta" id="div_alerta_temperatura"> </div>

        </div>
      </div>

      <div class="estufas">
        <h4>Estufa <span name="namecaminhao" id="idSensor" value="2">2</span></h4>
        <div class="valores">
          <div class="valor" id="div_temperatura2">Temperatura sendo obtida...</div>

        </div>

        <div class="alertas">
          <div class="alerta" id="div_alerta_temperatura2"></div>

        </div>
      </div>

      <div class="estufas">
        <h4>Estufa <span name="namecaminhao" id="idSensor" value="3">3</span></h4>
        <div class="valores">
          <div class="valor" id="div_temperatura3">Temperatura sendo obtida...</div>

        </div>
        <div class="alertas">
          <div class="alerta" id="div_alerta_temperatura3"></div>

        </div>
      </div>

      <div class="estufas">
        <h4>Estufa <span name="namecaminhao" id="idSensor" value="4">4</span></h4>
        <div class="valores">
          <div class="valor" id="div_temperatura4">Temperatura sendo obtida...</div>

        </div>

        <div class="alertas">
          <div class="alerta" id="div_alerta_temperatura4"></div>

        </div>
      </div>

      <div class="estufas">
        <h4>Estufa <span name="namecaminhao" id="idSensor" value="5">5</span></h4>
        <div class="valores">
          <div class="valor" id="div_temperatura5">Temperatura sendo obtida...</div>

        </div>

        <div class="alertas">
          <div class="alerta" id="div_alerta_temperatura5"></div>

        </div>
      </div>


    </div>
  </div>


  <script src="script/funcoes.js"></script>
</body>


<script>

  function comeco() {
    const estufas = document.querySelectorAll(".estufas");
    console.log(estufas)
    estufas.forEach((estufinha, index) => {
      if (estufinha.classList.contains("gelado") || estufinha.classList.contains("quente") ||
        estufinha.classList.contains("alerta_alto") ||
        estufinha.classList.contains("alerta_baixo")) {
        estufas[index].style.display = "flex";
      } else {
        estufas[index].style.display = "none";
      }

    })
  }

  setTimeout(() => {
    comeco();
  }, 1000);
  function estufas() {
    const estufas = document.querySelectorAll(".estufas");
    // if (carregar == 10) {
    //     console.log(estufas)
    //     estufas.forEach((estufinha, index) => {
    //         if (estufinha.classList.contains("gelado") || estufinha.classList.contains("quente") ||
    //             estufinha.classList.contains("alerta_alto") ||
    //             estufinha.classList.contains("alerta_baixo")) {
    //             estufas[index].style.display = "flex";
    //         } else {
    //             estufas[index].style.display = "none";
    //         }

    //     })
    // }

    if (selecao.value == "todas") {

      estufas.forEach((estufinha, index) => {
        if (estufinha.classList.contains("gelado") || estufinha.classList.contains("quente") ||
          estufinha.classList.contains("alerta_alto") ||
          estufinha.classList.contains("alerta_baixo")) {
          estufas[index].style.display = "flex";
        } else {
          estufas[index].style.display = "none";
        }

      })
    }
    if (selecao.value == 1) {

      estufas.forEach((estufinha, index) => {
        if (index == 0) {
          console.log(selecao.value)
          estufas[index].style.display = "flex";
        } else {
          console.log(selecao.value)
          estufas[index].style.display = "none";
        }
      })
    }
    if (selecao.value == 2) {

      estufas.forEach((estufinha, index) => {
        if (index == 1) {
          console.log(selecao.value)
          estufas[index].style.display = "flex";
        } else {
          console.log(selecao.value)
          estufas[index].style.display = "none";
        }
      })
    }
    if (selecao.value == 3) {

      estufas.forEach((estufinha, index) => {
        if (index == 2) {
          console.log(selecao.value)
          estufas[index].style.display = "flex";
        } else {
          console.log(selecao.value)
          estufas[index].style.display = "none";
        }
      })
    }
    if (selecao.value == 4) {

      estufas.forEach((estufinha, index) => {
        if (index == 3) {
          console.log(selecao.value)
          estufas[index].style.display = "flex";
        } else {
          console.log(selecao.value)
          estufas[index].style.display = "none";
        }
      })
    }
    if (selecao.value == 5) {

      estufas.forEach((estufinha, index) => {
        if (index == 4) {
          console.log(selecao.value)
          estufas[index].style.display = "flex";
        } else {
          console.log(selecao.value)
          estufas[index].style.display = "none";
        }
      })
    }

  }
  function btnestufa(tipo, event) {
    setTimeout(() => {
      id_estadoestufa.classList.add("soom")
    }, 1500)
    id_estadoestufa.classList.remove("soom")
    const estufas = document.querySelectorAll(".estufas");
    const linkst = document.querySelectorAll(".linkst");
    var plick = Array.from(linkst);

    plick.forEach((p) => {
      p.classList.remove("acttv")
    })

    event.preventDefault();
    if (tipo == "frio") {
      plick[0].classList.add("acttv")
      estufas.forEach((estufinha, index) => {


        if (estufinha.classList.contains("normal") || estufinha.classList.contains("quente") || estufinha.classList.contains("alerta_alto")) {
          estufas[index].style.display = "none";
        } else {
          estufas[index].style.display = "flex";

          id_estadoestufa.classList.add("gld");
          id_estadoestufa.classList.remove("qtd");
          id_estadoestufa.classList.remove("todas");
        }

      });

    }

    if (tipo == "quente") {
      plick[1].classList.add("acttv")
      estufas.forEach((estufinha, index) => {

        if (estufinha.classList.contains("normal") || estufinha.classList.contains("gelado") || estufinha.classList.contains("alerta_baixo")) {
          estufas[index].style.display = "none";
        } else {
          estufas[index].style.display = "flex";

          id_estadoestufa.classList.add("qtd");
          id_estadoestufa.classList.remove("gld");
          id_estadoestufa.classList.remove("todas");
        }

      });

    }

    if (tipo == "todas") {
      plick[2].classList.add("acttv")
      estufas.forEach((estufinha, index) => {

        estufas[index].style.display = "flex";

        id_estadoestufa.classList.add("todas");
        id_estadoestufa.classList.remove("qtd");
        id_estadoestufa.classList.remove("gld");

      });

    }

  }

  function trocanome() {
    var nome = sessionStorage.nome_usuario;
    c_usuario.innerHTML = nome;
  }
  trocanome();
  let usuario;
  console.log(usuario)
  verificar_autenticacao();

  // só mexer se quiser alterar o tempo de atualização
  // ou se souber o que está fazendo!
  function atualizacaoPeriodica() {
    obterdadosporcaminhao(1);
    obterdadosporcaminhao(2);
    obterdadosporcaminhao(3);
    obterdadosporcaminhao(4);
    obterdadosporcaminhao(5);
    setTimeout(atualizacaoPeriodica, 5000);
  }



  function obterdadosporcaminhao(idSensor) {
    //aguardar();
    fetch(`/leituras/tempo-real/${idSensor}`)
      .then(resposta => {

        if (resposta.ok) {
          resposta.json().then(function (resposta) {



            // aqui, após registro. use os nomes 
            // dos atributos que vem no JSON 
            var dados = {
              temperatura: resposta.temperatura,

            }

            alertar(resposta.temperatura, idSensor);
            atualizarTela(dados, idSensor);
          });
        } else {

          console.error('Nenhum dado encontrado ou erro na API');
        }
      })
      .catch(function (error) {
        console.error(`Erro na obtenção dos dados do caminhao p/ gráfico: ${error.message}`);
      });
  }

  function alertar(temperatura, idSensor) {
    // padrão para meu alerta
    var limites = {
      max_temperatura: 30,
      min_temperatura: 15,
      alerta_tempbaixa: 18,
      alerta_tempalta: 22

    };

    // zerar aviso de mensagem
    // zerar aviso de mensagem
    var mensagem_temperatura = '';

    var classe_temperatura = 'alerta';


    // comparando
    if (temperatura > limites.max_temperatura) {
      mensagem_temperatura += ' <p class="alertaP">Estufa com temperatura <b>alta </b>!</p>';
      classe_temperatura = 'alerta alerta-alto';
    }

    if (temperatura < limites.min_temperatura) {
      mensagem_temperatura = '<p class="alertaP">Estufa com temperatura <b>baixa </b>!</p>';
      classe_temperatura = 'alerta alerta-baixo';
    }

    if (temperatura < limites.alerta_tempbaixa && temperatura > limites.min_temperatura) {
      mensagem_temperatura = '<p class="alertaP">Estufa com temperatura <b> em alerta </b>!</p>';
      classe_temperatura = 'alerta alerta-tempbaixo';
    }

    if (temperatura > limites.alerta_tempalta && temperatura < limites.max_temperatura) {
      mensagem_temperatura = '<p class="alertaP">Estufa com temperatura <b>em alerta </b>!</p>';
      classe_temperatura = 'alerta alerta-tempalto';
    }


    // escolhendo qual alterar
    var div_temperatura_alterar


    if (idSensor == 1) {
      div_temperatura_alterar = div_alerta_temperatura

    } else if (idSensor == 2) {
      div_temperatura_alterar = div_alerta_temperatura2

    } else if (idSensor == 3) {
      div_temperatura_alterar = div_alerta_temperatura3

    } else if (idSensor == 4) {
      div_temperatura_alterar = div_alerta_temperatura4
      // div_alerta_temperatura4.setAttribute("class", "gelado");

    } else if (idSensor == 5) {
      div_temperatura_alterar = div_alerta_temperatura5
    }

    // alterando
    div_temperatura_alterar.innerHTML = mensagem_temperatura;
    div_temperatura_alterar.className = classe_temperatura;

    const estufinhas = document.querySelectorAll(".alerta");
    var estufonas = document.querySelectorAll(".estufas");
    estufinhas.forEach((estufa, index) => {
      if (estufa.classList.contains("alerta-tempbaixo")) {
        estufonas[index].classList.remove("normal");
        estufonas[index].classList.remove("quente");
        estufonas[index].classList.remove("gelado");
        estufonas[index].classList.remove("alerta_alto");
        estufonas[index].classList.add("alerta_baixo");
      }
      if (estufa.classList.contains("alerta-tempalto")) {
        estufonas[index].classList.remove("normal");
        estufonas[index].classList.remove("quente");
        estufonas[index].classList.remove("gelado");
        estufonas[index].classList.remove("alerta_baixo");
        estufonas[index].classList.add("alerta_alto");
      }
      if (estufa.classList.contains("alerta-baixo")) {
        estufonas[index].classList.remove("normal");
        estufonas[index].classList.remove("quente");
        estufonas[index].classList.remove("alerta_baixo");
        estufonas[index].classList.remove("alerta_alto");
        estufonas[index].classList.add("gelado");
      }

      if (estufa.classList.contains("alerta-alto")) {
        estufonas[index].classList.remove("normal");
        estufonas[index].classList.remove("gelado");
        estufonas[index].classList.remove("alerta_baixo");
        estufonas[index].classList.remove("alerta_alto");
        estufonas[index].classList.add("quente");
      }
      if (!(estufa.classList.contains("alerta-alto")) && !(estufa.classList.contains("alerta-baixo")) && !
        (estufa.classList.contains("alerta-tempbaixo")) &&
        !(estufa.classList.contains("alerta-tempalto"))) {
        estufonas[index].classList.add("normal");
        estufonas[index].classList.remove("gelado");
        estufonas[index].classList.remove("alerta_baixo");
        estufonas[index].classList.remove("alerta_alto");
        estufonas[index].classList.remove("quente");
      }

    })


  }

  // só altere aqui se souber o que está fazendo!
  function atualizarTela(dados, idSensor) {


    // escolhendo qual alterar
    var div_temperatura_alterar


    if (idSensor == 1) {
      div_temperatura_alterar = div_temperatura

    } else if (idSensor == 2) {
      div_temperatura_alterar = div_temperatura2

    } else if (idSensor == 3) {
      div_temperatura_alterar = div_temperatura3

    } else if (idSensor == 4) {
      div_temperatura_alterar = div_temperatura4

    } else if (idSensor == 5) {
      div_temperatura_alterar = div_temperatura5
    }

    div_temperatura_alterar.innerHTML = `Temperatura: ${dados.temperatura}º`;

  }


  function sendData() {
    var http = new XMLHttpRequest();
    http.open('GET', 'http://localhost:9001/api/sendData', false);
    http.send(null);
  }
  // Descomente abaixo se quiser inserir dados a cada X segundos
  setInterval(() => {
    sendData();
  }, 5000);

  setInterval(() => {
    window.location.reload(1);
  }, 5000);

</script>